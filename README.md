# Margarine6 - Telegram Bot для загрузки видео

**Margarine6** - это многофункциональный Telegram-бот для скачивания видео с популярных платформ, включая YouTube, Instagram и другие поддерживаемые сервисы. Бот автоматически обрабатывает видео, конвертирует их в совместимые форматы и отправляет пользователям.

## Основные возможности

**Поддержка платформ:** YouTube (включая Shorts), Instagram (Reels), Vimeo и другие сервисы через yt-dlp  
**Автоматическая обработка:** Конвертация видео в H.264/AAC для оптимальной совместимости с Telegram  
**Умное разделение:** Автоматическое деление больших файлов (>50 MB) на части по 10 минут  
**Адаптивное качество:** Выбор оптимального разрешения (480p, 720p, 360p)  
**Прокси-поддержка:** Использование Tor для обхода блокировок (socks5://127.0.0.1:9050)  
**Система подписки:** Проверка подписки на канал перед предоставлением услуг  
**Административные функции:** Команды для мониторинга и управления загрузками  

## Технические особенности

**FFmpeg интеграция:** Автоматическая конвертация и оптимизация видео для Telegram  
**Безопасность файлов:** Санитизация имен файлов для предотвращения конфликтов  
**Прогресс-бар:** Отображение процента загрузки в реальном времени  
**Автоматическая очистка:** Удаление временных файлов после обработки  
**Уведомления админу:** Мониторинг всех активностей пользователей и ошибок  

## Структура проекта

```

Margarine6/
├── bot/
│   ├── __init__.py
│   ├── config.py
│   ├── main.py
│   ├── video_sender.py
│   ├── downloads_manager.py
│   └── downloads/
├── .github/
│   └── workflows/
│       └── deploy.yml
├── deploy.sh
├── run.py
├── .env.example
├── .gitignore
└── margarine_intro.mp4

```

## Команды бота

### Пользовательские
- `/start`, `/help` — приветствие и видеоинструкция  
- Отправка ссылки — автоматическая загрузка видео  

### Административные
- `/show_downloads` — просмотр содержимого папки загрузок  
- `/clean_downloads` — очистка папки загрузок  
- `/youtube_blocked_test` — тест загрузки через Tor  
- `/instagram_test` — тест Instagram-загрузки  

## Технические детали

### Обработка видео

1. **Загрузка:** yt-dlp с адаптивным форматом  
2. **Конвертация:** FFmpeg в H.264/AAC (CRF 23, preset fast, movflags faststart)  
3. **Оптимизация:** пересборка файла и извлечение разрешения  
4. **Разделение:** при размере >50 MB деление на сегменты по 10 минут  

### Стратегия форматов

```

def get_format_str(url):
if 'instagram.com' in url or 'vimeo.com' in url:
return 'b'
elif 'youtube.com/shorts/' in url:
return 'bv*+ba/b/best'
else:
return (
"bestvideo[height=480]+bestaudio/best[height=480]/"
"bestvideo[height=720]+bestaudio/best[height=720]/"
"bestvideo[height=360]+bestaudio/best[height=360]/"
"bv*+ba/b/best"
)

```

### Система прокси

1. Прямое подключение  
2. Fallback через Tor (socks5://127.0.0.1:9050)  

## Безопасность и мониторинг

### Уведомления админу
- Новые пользователи и их запросы  
- Успешные загрузки с метаданными  
- Ошибки и исключения  
- Разделение больших файлов  

### Контроль доступа
- Проверка подписки на канал перед обработкой запросов  
- Административные команды доступны только владельцу  
- Санитизация входных данных  

## Особенности реализации

**config.py:** централизованная конфигурация через `.env`  
**video_sender.py:** изолированная логика отправки и деления видео  
**downloads_manager.py:** утилиты для управления файлами  
**main.py:** основная логика бота и обработчики сообщений  

### Обработка ошибок
- Graceful fallback на Tor при недоступности  
- Автоматическая очистка при сбоях  
- Детализированное логирование для отладки  
```